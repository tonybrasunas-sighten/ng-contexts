(function(a){'use strict';var b=a.module("ng-contexts",[]);b.service("Contexts",["$log","$rootScope","$q",function(b,c,d){var e=this,f=function(a){return a};this.contexts={},this.models={},c.current={},this.register=function(a){this.contexts[a.name]=a.rels||[],this.models[a.name]=(a.model||f).bind(a),this.identifier=a.identifier||"uuid",a.select=function(){return e.select.apply(a,[a.name].concat(Array.prototype.slice.call(arguments)))},a.refresh=e.refreshing(a),a.use=e.using(a),a.modify=e.modifying(a),a.selected=function(){return e.getOr(a.name,!1)},a.exists=function(){return e.existing(a.name,!1)},a.clear=function(){return e.clear(a.name)},a.clearSubscriptions=function(){return e.clear(a.name,!0,!0,!1)},a.$$hasContext=!0,c.current[name]={}},this.refreshing=function(a){return function(c,e){var g=c instanceof Function?c.call(a,a):a[c].bind(a),h=a.model||f;g instanceof Function?d.when(g.call(a)).then(function(b){e(b instanceof Array?b.map.call(a,h,a):h.call(a,b))}).catch(function(a){b.error("[ng-contexts.refreshing] failed to refresh Service integration point",a)}):b.error("[ng-contexts.refreshing] failed to find method on service",c)}.bind(a)},this.modifying=function(a){return function(c,d=!1){if(this.exists()){var f=this.selected(),g=Object.assign(f,c);return d&&e.publish(a.name,g),g}return b.error("[ng-contexts.modifying] No selected data to modify found for service",a),!1}},this.using=function(a){return function(c,d,f){if(a.$$hasContext){f||a.refresh(c,d);var g=e.subscribe(a.name,function(b){a.refresh(c,d),a.rels&&a.rels.length&&a.rels.forEach(function(a){e.publish(a,b)})});return g.stop=g,g}return b.error("[ng-contexts.using] malformed Service context, please ensure you have added `Contexts.register(this)` at the end of this service",a),!1}.bind(a)},this.clear=function(a,b=!0,d=!0,f=!0){var g=e.contexts[a]||[];g.forEach(function(a){f&&delete c.current[a],d&&e.unsubscribe(a);var g=e.contexts[a];g instanceof Array&&g.length&&g.forEach(function(a){e.clear(a,b,d,f)})}),b&&f&&delete c.current[a],d&&e.unsubscribe(a)},this.select=function(b,d,f,g){var h=c.current[b],i=e.identifier;return(!a.equals(d,h)||f)&&(g&&(d=e.models[b](d)),c.current[b]=d,e.clear(b,!1,!1),e.publish(b,d)),d},this.existing=function(a,b=!1){var c=this.currentOr(a,b);return c&&!!c[this.identifier]},this.selected=function(a,b=!1){return this.currentOr(a,b)},this.current=function(a,b){var d=c.current[a];return!1===b?d:this.models[a](d||{})},this.currentOr=function(b,c,d){var e=this.current(b,d);return a.isObject(e)||a.isUndefined(c)?e:c},this.get=e.current,this.getOr=e.currentOr,this.subscribe=function(a,b){var d=c.$on(a,function(a,c){b(c||{},a)});return d},this.unsubscribe=function(a){c.$$listeners[a]=[]},this.publish=function(a,b){var d=e.contexts[a],f=d?[a].concat(d):[a];return f.forEach(function(a){if(a.constructor===String)c.$broadcast(a,b);else throw"rels must be Strings"}),b}}])})(angular),module&&exports&&module.exports===exports&&(module.exports="ng-contexts");